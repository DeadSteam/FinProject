<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вход в систему | RealTimeFinanceAnalytics</title>
    <link rel="stylesheet" href="../styles/common.css">
    <link rel="stylesheet" href="../styles/pages/login.css">
</head>
<body>
    <div class="login-page">
        <div class="login-backdrop">
            <div class="floating-particle"></div>
            <div class="floating-particle"></div>
            <div class="floating-particle"></div>
            <div class="floating-particle"></div>
            <div class="floating-particle"></div>
            <div class="floating-particle"></div>
        </div>
        <div class="particles-overlay"></div>
        
        <a href="../index.html" class="back-link">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"></path>
            </svg>
            <span>На главную</span>
        </a>
        
        <div class="login-container">
            <div class="login-logo">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 4h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2zm3 5a1 1 0 0 0 0 2h10a1 1 0 1 0 0-2H7zm0 4a1 1 0 0 0 0 2h10a1 1 0 1 0 0-2H7z"/>
                </svg>
                <div class="logo-text">RealTimeFinance</div>
            </div>
            
            <div class="login-header">
                <h1>Добро пожаловать</h1>
                <p>Войдите в свой аккаунт для доступа к аналитике</p>
            </div>
            
            <form id="loginForm" class="animate-form">
                <div class="input-group">
                    <label for="identifier">Email / Телефон</label>
                    <div class="input-wrapper">
                        <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <input type="text" id="identifier" name="identifier" class="input" required placeholder="Введите email или номер телефона">
                    </div>
                    <div class="error-message" id="identifierError"></div>
                </div>
                
                <div class="input-group">
                    <label for="password">Пароль</label>
                    <div class="input-wrapper">
                        <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                        <input type="password" id="password" name="password" class="input" required placeholder="Введите ваш пароль">
                        <button type="button" class="password-toggle" id="togglePassword">
                            <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                    </div>
                    <div class="error-message" id="passwordError"></div>
                </div>
                
                <div class="login-options">
                    <div class="remember-me">
                        <label class="custom-checkbox">
                            <input type="checkbox" id="remember" name="remember">
                            <span class="checkbox-indicator"></span>
                            <span class="checkbox-label">Запомнить меня</span>
                        </label>
                    </div>
                    <a href="#" class="forgot-password">Забыли пароль?</a>
                </div>
                
                <button type="submit" class="login-btn" id="loginButton">Войти</button>
                
                <div class="login-divider">
                    <span>или</span>
                </div>
                
                <div class="social-login">
                    <button type="button" class="social-btn social-google">
                        <svg viewBox="0 0 24 24" width="18" height="18">
                            <path d="M12.545 10.239v3.818h5.556c-.226 1.338-1.682 3.673-5.556 3.673-3.442 0-6.251-2.851-6.251-6.364s2.809-6.364 6.251-6.364c1.898 0 3.17.81 3.898 1.515l2.665-2.565C17.951 2.984 15.566 2 12.545 2 7.021 2 2.543 6.477 2.543 12s4.478 10 10.002 10c5.776 0 9.612-4.091 9.612-9.818 0-.757-.085-1.41-.189-2.018l-9.423.075z" fill="#EA4335"/>
                        </svg>
                        <span>Google</span>
                    </button>
                    <button type="button" class="social-btn social-microsoft">
                        <svg viewBox="0 0 24 24" width="18" height="18">
                            <path d="M11.4 24H0V12.6h11.4V24z" fill="#F25022"/>
                            <path d="M24 24H12.6V12.6H24V24z" fill="#00A4EF"/>
                            <path d="M11.4 11.4H0V0h11.4v11.4z" fill="#7FBA00"/>
                            <path d="M24 11.4H12.6V0H24v11.4z" fill="#FFB900"/>
                        </svg>
                        <span>Microsoft</span>
                    </button>
                </div>
                
                <div class="login-footer">
                    <div class="security-info">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                        <span>Защищено шифрованием</span>
                    </div>
                    <p>© 2024 <a href="#">RealTimeFinanceAnalytics</a></p>
                </div>
            </form>
        </div>
    </div>

    <!-- Импортируем скрипт авторизации -->
    <script type="module">
        // Импортируем сервис авторизации и утилиты
        import authService from '../scripts/auth/auth.js';
        import { isValidEmail, isValidPhoneNumber, formatPhoneNumber } from '../scripts/utils/validation.js';
        
        // Переключение видимости пароля
        document.getElementById('togglePassword').addEventListener('click', function() {
            const passwordInput = document.getElementById('password');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                this.classList.add('active');
            } else {
                passwordInput.type = 'password';
                this.classList.remove('active');
            }
        });
        
        // Живая валидация
        const validateInput = (input, validateFn, errorElement, errorMessage) => {
            const value = input.value.trim();
            const isValid = validateFn(value);
            
            if (value === '') {
                input.parentElement.classList.remove('valid', 'invalid');
                errorElement.style.display = 'none';
                return true;
            } else if (isValid) {
                input.parentElement.classList.add('valid');
                input.parentElement.classList.remove('invalid');
                errorElement.style.display = 'none';
                return true;
            } else {
                input.parentElement.classList.add('invalid');
                input.parentElement.classList.remove('valid');
                errorElement.textContent = errorMessage;
                errorElement.style.display = 'block';
                return false;
            }
        };
        
        // Валидация идентификатора (email или телефон)
        const identifierInput = document.getElementById('identifier');
        const identifierError = document.getElementById('identifierError');
        
        // Функция для проверки идентификатора
        const validateIdentifier = (value) => {
            // Если значение похоже на email, проверяем его
            if (value.includes('@')) {
                return isValidEmail(value);
            }
            
            // В противном случае считаем, что это телефон
            return value.replace(/\D/g, '').length >= 10;
        };
        
        // Валидация идентификатора при вводе
        identifierInput.addEventListener('input', () => {
            validateInput(
                identifierInput,
                validateIdentifier,
                identifierError,
                'Пожалуйста, введите корректный email или номер телефона'
            );
            
            // Если ввод похож на номер телефона, автоматически форматируем его при потере фокуса
            if (!identifierInput.value.includes('@')) {
                identifierInput.addEventListener('blur', function() {
                    if (this.value.trim()) {
                        this.value = formatPhoneNumber(this.value);
                    }
                });
            }
        });
        
        // Валидация пароля
        const passwordRegex = /.{6,}/;
        const passwordInput = document.getElementById('password');
        const passwordError = document.getElementById('passwordError');
        
        passwordInput.addEventListener('input', () => {
            validateInput(
                passwordInput,
                (value) => passwordRegex.test(value),
                passwordError,
                'Пароль должен содержать минимум 6 символов'
            );
        });
        
        // Обработка отправки формы
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const identifier = identifierInput.value.trim();
            const password = passwordInput.value;
            
            // Валидация
            const isIdentifierValid = validateInput(
                identifierInput,
                validateIdentifier,
                identifierError,
                'Пожалуйста, введите корректный email или номер телефона'
            );
            
            const isPasswordValid = validateInput(
                passwordInput, 
                (value) => passwordRegex.test(value),
                passwordError, 
                'Пароль должен содержать минимум 6 символов'
            );
            
            // Если все в порядке, отправляем форму
            if (isIdentifierValid && isPasswordValid) {
                console.log('Попытка входа:', { identifier, password });
                const button = document.getElementById('loginButton');
                button.disabled = true;
                button.textContent = 'Подождите...';
                
                try {
                    // Выполняем запрос авторизации через API
                    const authResult = await authService.login(identifier, password);
                    
                    // Выводим информацию о токене в консоль для отладки
                    console.log('Успешная авторизация', {
                        token: authResult.tokens.access_token,
                        tokenType: authResult.tokens.token_type,
                        user: authResult.user
                    });
                    
                    // Если вход успешен, перенаправляем на главную страницу
                    window.location.href = "../index.html";
                } catch (error) {
                    console.error('Ошибка входа:', error);
                    // Показываем информативную ошибку
                    let errorMessage = 'Неверные учетные данные';
                    
                    if (error.message.includes('fetch') || error.message.includes('network') || error.message.includes('Failed to fetch')) {
                        errorMessage = 'Ошибка соединения с сервером. Проверьте, что сервер запущен.';
                    }
                    
                    passwordError.textContent = errorMessage;
                    passwordError.style.display = 'block';
                    
                    // Восстанавливаем кнопку
                    button.disabled = false;
                    button.textContent = 'Войти';
                }
            }
        });
        
        // Анимация формы при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                document.getElementById('loginForm').classList.add('visible');
            }, 100);
        });
    </script>
</body>
</html>
