# Финансовый проект

Проект для управления финансовыми данными с использованием чистой архитектуры, SQLAlchemy и асинхронного кода.

## Стек технологий

- Python 3.11
- FastAPI
- SQLAlchemy (асинхронный режим)
- PostgreSQL
- Docker и Docker Compose

## Структура проекта

```
.
├── src/
│   ├── api/         # API маршруты
│   ├── core/        # Основные компоненты (конфигурация, подключение к БД)
│   ├── model/       # Модели данных SQLAlchemy
│   ├── scheme/      # Pydantic схемы
│   └── service/     # Бизнес-логика
├── sql/
│   └── init/        # SQL скрипты для инициализации баз данных
├── Dockerfile       # Конфигурация Docker образа
├── docker-compose.yml  # Конфигурация Docker Compose
├── entrypoint.sh    # Скрипт для запуска приложения
├── main.py          # Точка входа приложения
└── requirements.txt # Зависимости проекта
```

## Настройка переменных окружения

Для работы проекта необходимо настроить следующие переменные окружения (или создать файл `.env` в корне проекта):

```
# Настройки приложения
DEBUG=True
APP_ENV=development
SECRET_KEY=your-strong-secret-key-replace-in-production

# Настройки баз данных для разработки
DATABASE_URL=postgresql+asyncpg://postgres:postgres@localhost:5434/finance_db
USERS_DATABASE_URL=postgresql+asyncpg://postgres:postgres@localhost:5435/users_db
POSTGRES_PASSWORD=postgres
POSTGRES_USER=postgres

# Настройки PgAdmin
PGADMIN_EMAIL=admin@admin.com
PGADMIN_PASSWORD=admin
```

## Запуск проекта

### С использованием Docker Compose

1. Клонировать репозиторий
2. Создать файл `.env` с необходимыми переменными окружения (см. раздел выше)
3. Запустить контейнеры:
   ```
   docker-compose up -d
   ```
4. Приложение будет доступно по адресу http://localhost:8000
5. pgAdmin доступен по адресу http://localhost:5050 (логин: admin@admin.com, пароль: admin)

### Локальный запуск

1. Клонировать репозиторий
2. Создать виртуальное окружение:
   ```
   python -m venv .venv
   source .venv/bin/activate  # Linux/MacOS
   .venv\Scripts\activate     # Windows
   ```
3. Установить зависимости:
   ```
   pip install -r requirements.txt
   ```
4. Создать файл `.env` с переменными окружения
5. Запустить приложение:
   ```
   uvicorn main:app --reload
   ```

## Базы данных

Проект использует две отдельные базы данных:
- `finance_bd` - для хранения финансовой информации
- `users_db` - для хранения данных пользователей и их ролей

## API

Документация API доступна по адресу http://localhost:8000/docs после запуска приложения.

Основные эндпоинты:
- `/api/v1/finance/` - эндпоинты для работы с финансовыми данными
- `/api/v1/users/` - эндпоинты для работы с пользователями

## Архитектура

Проект следует принципам чистой архитектуры:
- Слой моделей данных (model)
- Слой бизнес-логики (service)
- Слой API (api)

Все взаимодействия между слоями происходят через интерфейсы, что обеспечивает слабую связность компонентов.

## Система авторизации

### Основные компоненты

1. **Аутентификация и авторизация**
   - Вход по username/email и паролю
   - JWT-токены (access и refresh)
   - Проверка ролей пользователей
   - Обновление токенов без повторного входа
   - Безопасный выход из системы

2. **Безопасность**
   - Защита от brute-force атак с временной блокировкой после неудачных попыток
   - Хранение refresh токенов в httpOnly куках
   - CORS защита
   - Защита от атак через фиксацию хоста
   - Сжатие ответов для оптимизации

3. **Управление пользователями**
   - Регистрация нового пользователя с подтверждением пароля
   - Редактирование профиля
   - Управление ролями
   - Сброс пароля через email

### Эндпоинты

#### Авторизация

- `POST /api/v1/auth/register` - Регистрация нового пользователя
- `POST /api/v1/auth/login` - Авторизация и получение токенов
- `POST /api/v1/auth/token` - Авторизация через форму OAuth2
- `POST /api/v1/auth/refresh` - Обновление access токена
- `POST /api/v1/auth/logout` - Выход из системы
- `POST /api/v1/auth/reset-password` - Запрос на сброс пароля

#### Пользователи

- `GET /api/v1/users/` - Получение списка пользователей (только для админов)
- `POST /api/v1/users/` - Создание пользователя (только для админов)
- `GET /api/v1/users/me` - Получение данных текущего пользователя
- `PUT /api/v1/users/me` - Обновление своих данных
- `GET /api/v1/users/{user_id}` - Получение данных пользователя (только для админов)
- `PUT /api/v1/users/{user_id}` - Обновление пользователя (только для админов)
- `DELETE /api/v1/users/{user_id}` - Удаление пользователя (только для админов)

#### Роли

- `GET /api/v1/users/roles` - Получение списка ролей (только для админов)
- `POST /api/v1/users/roles` - Создание новой роли (только для админов)
- `GET /api/v1/users/roles/{role_id}` - Получение данных роли (только для админов)
- `PUT /api/v1/users/roles/{role_id}` - Обновление роли (только для админов)
- `DELETE /api/v1/users/roles/{role_id}` - Удаление роли (только для админов)

## Перенос логики с клиента на сервер

В проекте был выполнен перенос части клиентской логики на сервер FastAPI для оптимизации производительности и улучшения архитектуры приложения. Были выполнены следующие изменения:

### 1. Поиск и фильтрация магазинов
- Создан новый эндпоинт `/api/v1/finance/shops/search` для поиска и фильтрации магазинов
- Добавлен метод `search_shops` в класс `ShopService` для серверной фильтрации по имени, адресу, описанию и статусу
- Обновлен клиентский код для использования нового эндпоинта

### 2. Поиск и фильтрация пользователей
- Создан новый эндпоинт `/api/v1/users/search` для поиска и фильтрации пользователей
- Добавлен метод `search_users` в класс `UserService` для серверной фильтрации по имени пользователя, email, имени, роли и статусу
- Обновлен клиентский код для использования нового эндпоинта

### 3. Агрегация данных для графиков
- Создан новый эндпоинт `/api/v1/finance/metrics/with-data` для получения метрик с агрегированными данными для построения графиков
- Добавлен метод `get_metrics_with_values_for_charts` в класс `MetricService` для агрегации плановых и фактических значений
- Обновлен клиентский код для использования нового эндпоинта и работы с серверными данными

### 4. Поиск и фильтрация метрик
- Создан новый эндпоинт `/api/v1/finance/metrics/search` для поиска и фильтрации метрик
- Добавлен метод `search_metrics` в класс `MetricService` для серверной фильтрации по имени, единице измерения и категории
- Обновлен клиентский код для использования нового эндпоинта

### 5. Расчет бюджетной статистики
- Создан новый эндпоинт `/api/v1/finance/budget-statistics` для получения агрегированных данных по бюджету
- Добавлен метод `calculate_budget_statistics` в класс `MetricService` для расчета общих плановых и фактических значений, процента выполнения и статуса бюджета
- Добавлен метод для вызова API в клиентскую часть

### 6. Группировка периодов по типам
- Создан новый эндпоинт `/api/v1/finance/periods/grouped` для получения периодов, сгруппированных по типу (год, квартал, месяц)
- Добавлен метод `get_periods_grouped_by_type` в класс `PeriodService` для группировки периодов
- Добавлен метод для вызова API в клиентскую часть

Эти изменения позволили:
- Уменьшить объем передаваемых данных между клиентом и сервером
- Сократить время обработки данных на клиенте
- Повысить производительность приложения 
- Улучшить модульность и поддерживаемость кода 