# Внедрение каскадного удаления для метрик и магазинов

Чтобы добавить поддержку каскадного удаления в существующую базу данных, выполните следующие шаги:

## 1. Применение SQL-скрипта для обновления ограничений внешних ключей

Выполните следующую команду, чтобы применить SQL-скрипт к вашей базе данных PostgreSQL:

```bash
psql -U your_username -d your_database_name -f sql/update_cascade_delete.sql
```

Замените `your_username` и `your_database_name` на ваши реальные значения.

## 2. Обновление файлов Python-моделей

Файл `src/model/finance.py` уже обновлен для использования каскадного удаления в определениях моделей. Ничего делать не нужно, если вы используете последнюю версию кода.

## 3. Обновление файлов инициализации базы данных

Файл `sql/init/init_finance_db.sql` уже обновлен для включения каскадного удаления. Это гарантирует, что новые установки будут использовать правильные ограничения. 

## Проверка работы каскадного удаления

После применения изменений, когда вы удаляете метрику или магазин, все связанные записи в таблицах `actual_values` и `plan_values` будут автоматически удаляться.

Это поведение можно проверить следующим образом:

1. Выберите метрику, которая имеет связанные плановые и фактические значения
2. Попробуйте удалить эту метрику через API или напрямую в базе данных
3. Убедитесь, что все связанные значения также были удалены

Проверка SQL-запросом:
```sql
-- Находим метрику с плановыми значениями
SELECT m.id, m.name, COUNT(pv.id) as plan_count
FROM metrics m
LEFT JOIN plan_values pv ON m.id = pv.metric_id
GROUP BY m.id, m.name
ORDER BY plan_count DESC
LIMIT 1;

-- Запомните ID метрики из результата выше

-- Удаляем метрику напрямую
DELETE FROM metrics WHERE id = 'полученный_id_метрики';

-- Проверяем, что связанные плановые значения тоже удалены
SELECT * FROM plan_values WHERE metric_id = 'полученный_id_метрики';
-- Результат должен быть пустым
```

## Важное замечание

Будьте осторожны при удалении метрик и магазинов после внедрения каскадного удаления, поскольку это приведет к необратимому удалению всех связанных данных. Рекомендуется сделать резервную копию базы данных перед первым использованием. 